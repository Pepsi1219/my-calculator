<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSA Operation Sign-Off Report (v1.0.10)</title>
  
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
    <style>
        * { 
          box-sizing: border-box; 
          margin: 0; padding: 0; 
          font-family: 'Sarabun', sans-serif; 
      }
      
        body { 
          background: #f8f9fa; 
          padding: 15px; 
      }
        .report-container { 
          background: white; 
          padding: 20px; 
          border-radius: 8px; 
          box-shadow: 0 2px 10px rgba(0,0,0,.1); 
          max-width: 1550px; 
          margin: auto; 
      }
        .report-title { 
          text-align: center; 
          margin-bottom: 20px; 
          color: #1a3c6d; 
          border-bottom: 2px solid #1a3c6d; 
          padding-bottom: 10px;
      }
        .form-header { 
          display: grid; 
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
          gap: 12px 16px; 
          margin-bottom: 20px; 
          background: #f0f4ff; 
          padding: 15px; 
          border-radius: 8px; 
      }
        .field { 
          display: flex; 
          flex-direction: column; 
      }
        .field label { 
          font-size: .85rem; 
          margin-bottom: 4px; 
          font-weight: 600; 
          color: #444; }
      
        .field input, .field select { 
          padding: 8px 10px; 
          border: 1px solid #ccc; 
          border-radius: 5px; 
          font-size: 1rem; 
          background: white; 
      }
        .field input[readonly] { 
          background: #e9ecef; 
      }
        
        .table-wrapper { 
          overflow-x: auto; 
      }
      
        .report-table {
          width: 100%;
          background-color: #FFFFFF;
          border-collapse: collapse;
          min-width: 1400px;
          font-size: .75rem;
          table-layout: fixed;
      }
         .report-table input { 
          width: 100%;
          background-color: #FFFFFF;
          border: 0px; 
          padding: 4px; 
          text-align: center; 
          background: transparent; 
      }
      
        .cause-col {
          width: 40px;
      }
        th, td { 
          border: 1px solid #ccc; 
          padding: 6px; 
          text-align: center; 
          vertical-align: middle; 
      }
      
        th {
          background: #e9ecef; 
      }
      
        .day-cell { 
          background: #f0f4ff; 
          font-weight: bold;
      }
        
        .clickable-input { 
          cursor: pointer; 
          background: #fffde7 !important; 
          font-weight: bold; 
          border-radius: 4px;
      }
        
        .text-success { 
          color: #28a745 !important; 
          font-weight: bold; 
      }
      
        .text-danger { 
          color: #dc3545 !important; 
          font-weight: bold; 
      }

        .modal { 
          display: none; 
          position: fixed; 
          z-index: 1001; 
          left: 0; 
          top: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.8);
      }
      
        .modal-content { 
          background: white; 
          margin: 15% auto; 
          padding: 25px; 
          border-radius: 10px; 
          width: 90%; 
          max-width: 400px; 
          text-align: center; 
      }
      
        .modal-content input { 
          width: 100%; 
          padding: 12px; 
          font-size: 1.5rem; 
          text-align: center; 
          border: 2px solid #007bff; 
          border-radius: 8px; 
          margin-bottom: 20px; 
      }
        
       .stopwatch-bar { 
         background: #fff; 
         border: 0px solid #1a3c6d; 
         padding: 12px; 
         border-radius: 12px; 
         margin-bottom: 20px; 
         display: flex; 
         flex-wrap: wrap; 
         align-items: center; 
         justify-content: flex-end;
         gap: 15px; 
         position: sticky;
         top: 10px; 
         z-index: 100; 
         box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
      }
        .timer-display { 
          font-size: 1.8rem; 
          font-weight: bold; 
          font-family: monospace; 
          background: #222; 
          color: #00ff00; 
          padding: 5px 15px; 
          border-radius: 8px; 
          min-width: 140px; 
          text-align: center; 
      }
        .btn { 
          padding: 10px 16px; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          font-weight: bold; 
          color: white; 
          display: flex; 
          align-items: center; 
          gap: 5px; 
          transition: 0.2s; 
      }
      
        .btn-start { 
          background: #28a745; 
      }
        .btn-stop { 
          background: #dc3545;
      } 
        .btn-save { 
        background: #007bff; 
      }
       .btn-reset { 
         background: #6c757d;
      }
        .sign-btn-group { 
          display: flex;
          gap: 10px; 
          justify-content: center; 
      }
        
        .sign-cell { 
          cursor: pointer; 
          min-width: 20px; 
          height: 45px; 
          background: #fff; 
          display: flex; 
          align-items: center; 
          justify-content: center;
      }
      
        .sign-cell img { 
          max-height: 20px; 
          display: none;
      }
      
        #signature-pad { 
          border: 2px dashed #ccc; 
          background: #fff; margin-bottom: 15px; 
          touch-action: none;
      }
    </style>
</head>
<body>

<div class="report-container">
    <h1 class="report-title">CSA OPERATION SIGN-OFF REPORT</h1>
      <div style="display: flex; 
                  gap: 10px; 
                  justify-content: flex-end; 
                  margin: 20px 0;">
        
  <button class="btn" 
          onclick="exportToExcel()" 
          style="background: #28a745; 
                 color: white;
                 border: none;
                 padding: 10px 20px;
                 border-radius: 5px;
                 cursor: pointer;
                 font-size: 14px;
                 display: flex;
                 align-items: center;
                 gap: 5px;
                 transition: background 0.3s;">
    üìä Export to Excel
  </button>
  
  <button class="btn btn-reset" 
          onclick="clearAllData()" 
          style="background: #dc3545;
                 color: white;
                 border: none;
                 padding: 10px 20px;
                 border-radius: 5px;
                 cursor: pointer;
                 font-size: 14px;
                 display: flex;
                 align-items: center;
                 gap: 5px;
                 transition: background 0.3s;">
    üóëÔ∏è Clear All
  </button>
        
  <button class="btn" 
          onclick="showPerformanceChart()" 
          style="background: #17a2b8; 
                 color: white;
                 border: none;
                 padding: 10px 20px;
                 border-radius: 5px;
                 cursor: pointer;
                 font-size: 14px;
                 display: flex;
                 align-items: center;
                 gap: 5px;
                 transition: background 0.3s;">
    üìà ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
</button>
        

</div>
    <div class="form-header">
        <div class="field"><label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å</label>
          <input type="text"
                 id="header_process"></div>
      
        <div class="field"><label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input type="text"
                 id="header_employee"></div>
      
        <div class="field"><label>‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å</label>
          <input type="text"
                 id="header_trainer"></div>
      
        <div class="field"><label>SAM (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
          <input type="number" 
                 id="globalSam" 
                 step="0.001" 
                 inputmode="decimal"
              oninput="calculateAdaptiveGoals()">
      </div>
      
        <div class="field"><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Eff (%)</label>
          <input type="number" 
                 id="globalEffTarget" 
                 inputmode="numeric" 
                 oninput="calculateAdaptiveGoals()">
      </div>
      
        <div class="field">
          <label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Q'ty (‡∏ä‡∏¥‡πâ‡∏ô/‡∏ä‡∏°.)</label>
          <input type="number" 
                 id="globalQtyTarget" 
                 readonly>
      </div>
        <div class="field">
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label>
            <select id="workLevel">
              <option value="" 
                      disabled selected> </option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
        </div>
      
        <div class="field"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å</label>
          <input type="number" 
                 id="trainingDays" 
                 inputmode="numeric" 
                 oninput="calculateAdaptiveGoals()">
      </div>
      
        <div class="field">
            <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤</label>
            <select id="fabricType">
                <option value="" 
                        disabled selected></option>
                <option value="Knitted">‡∏ú‡πâ‡∏≤‡∏ñ‡∏±‡∏Å (Knitted)</option>
                <option value="Woven">‡∏ú‡πâ‡∏≤‡∏ó‡∏≠ (Woven)</option>
            </select>
        </div>
      
        <div class="field"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å</label>
          <input type="date"
                 id="header_startDate"></div>
      
        <div class="field">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</label>
          <input type="date"
                 id="header_transferDate">
          </div>
    </div>
  
    <div class="stopwatch-bar">
      
      <div id="timerDisplay" 
           class="timer-display">00:00:00
      </div>
      
        <button class="btn btn-start" 
                id="startStopBtn" 
                onclick="toggleTimer()">Start
      </button>
      
        <button class="btn btn-reset" 
                onclick="resetTimer()">Reset
      </button>
      
        <div class="control-group" 
             style="padding-left:15px; border-left:3px solid #007bff;">
        </div>
        <button class="btn btn-save" 
                onclick="recordAndCalculate()">üíæ Save</button>
      
 </div>
  <div style="display: flex; gap: 10px;">
     <div class="control-group">
         <label>‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà:</label>
         <input type="number"
                id="targetDay"
                value="1"
                min="1"
                max="30"
                inputmode="numeric"
                style="width: 60px; 
                       text-align: center;
                       border: 0px solid #007bff; 
                       font-weight: bold;">
        </div>

        <button id="btnPlanA" 
                class="btn" 
                onclick="adjustPlan('A')" 
                style="background: #dc3545; color: white;"
                disabled>‡πÅ‡∏ú‡∏ô A
        </button>

        <button id="btnPlanB" 
                class="btn" 
                onclick="adjustPlan('B')" 
                style="background: #28a745; color: white;"disabled>‡πÅ‡∏ú‡∏ô B
        </button>
    </div>
</div>
    <div class="table-wrapper">
        <table class="report-table">
            <table class="report-table">
              <colgroup>
                <col style="width:30px">
                <col span="6">
                <col span="3">
                <col class="cause-col">
                <col class="cause-col">
                <col class="cause-col">
                <col class="cause-col">
                <col style="width:180px">
                <col style="width:100px">
         </colgroup>
              
            <thead>
                <tr>
                    <th rowspan="2">‡∏ß‡∏±‡∏ô</th>
                    <th colspan="6">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</th>
                    <th colspan="3">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</th>
                    <th colspan="4">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å</th>
                    <th rowspan="2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                    <th rowspan="2">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</th>
                </tr>
                <tr>
                    <th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (%)</th>
                    <th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                    <th>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (%)</th>
                    <th>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                    <th>‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô %</th>
                    <th>‡∏Ñ‡∏ô</th>
                    <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                    <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>
    </div> 
      </div> 
</div>
  
          <div id="chartModal" 
               style="display:none; 
                      position:fixed; z-index:999; 
                      left:0; top:0; width:100%; 
                      height:100%; background:rgba(0,0,0,0.8);">
    <div style="background:white; 
                margin:5% auto; padding:20px; width:80%; border-radius:10px;">
        <span onclick="document.getElementById('chartModal').style.display='none'" 
              style="float:right; cursor:pointer; font-size:24px;">&times;</span>
      
        <h2 style="text-align:center;">‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ vs ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</h2>
        <canvas id="performanceChart" 
                width="400" 
                height="200"></canvas>
    </div>
</div>


  
<div id="manualInputModal" class="modal">
    <div class="modal-content">
        <h3>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="modalDayLabel"></span></p>
        <input type="number" 
               id="manualSecondsInput" 
               step="0.01" 
               inputmode="decimal" 
               placeholder="00">
        <div class="sign-btn-group">
            <button class="btn btn-save" 
                    onclick="saveManualSeconds()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-stop" 
                    onclick="closeManualModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<div id="signModal" class="modal">
    <div class="modal-content">
        <h3>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</h3>
        <canvas id="signature-pad" width="350" height="200"></canvas>
        <div class="sign-btn-group">
            <button class="btn btn-reset" 
                    onclick="clearPad()">‡∏•‡πâ‡∏≤‡∏á</button>
            <button class="btn btn-save" 
                    onclick="saveSignature()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-stop" 
                    onclick="closeSignPad()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<script>
  
// ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏ä‡πâ Date().toDateString())
let lastAdjustedDay = 0; 

function adjustPlan(type) {
    const trainDaysInput = document.getElementById('trainingDays');
    let trainDays = parseInt(trainDaysInput.value) || 0;

    // 1. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á
    let lastDay = 0;
    let lastEff = 0;
    let lastTarget = 0;

    for (let d = 1; d <= 30; d++) {
        const effVal = document.getElementById(`resEffPerc_${d}`).value;
        const targetVal = document.getElementById(`targetEff_${d}`).value;
        if (effVal !== "" && targetVal !== "") {
            lastDay = d;
            lastEff = parseFloat(effVal);
            lastTarget = parseFloat(targetVal);
        }
    }

    // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    if (lastDay === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô");
        return;
    }

    if (lastAdjustedDay === lastDay) {
        alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${lastDay} ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`);
        return;
    }

    // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô (Confirmation)
    if (type === 'A') {
        if (lastEff < lastTarget) {
            // ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô A
            const confirmA = confirm(`‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (${lastEff}%) ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (${lastTarget}%)\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            
            if (confirmA) {
                trainDays += 1;
                trainDaysInput.value = trainDays;
                lastAdjustedDay = lastDay;
                alert(`‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô A ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô ${trainDays} ‡∏ß‡∏±‡∏ô`);
            } else {
                return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            }
        } else {
            alert("‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á: ‡πÅ‡∏ú‡∏ô A ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤' ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            return;
        }
    } 
    else if (type === 'B') {
        if (lastEff > lastTarget) {
            if (trainDays > lastDay) {
                // ‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô B
                const confirmB = confirm(`‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (${lastEff}%) ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (${lastTarget}%)\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏•‡∏á 1 ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                
                if (confirmB) {
                    trainDays -= 1;
                    trainDaysInput.value = trainDays;
                    lastAdjustedDay = lastDay;
                    alert(`‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô B ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${trainDays} ‡∏ß‡∏±‡∏ô`);
                } else {
                    return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                }
            } else {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ù‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ");
                return;
            }
        } else {
            alert("‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á: ‡πÅ‡∏ú‡∏ô B ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á '‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤' ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            return;
        }
    }

    // 4. ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
    calculateAdaptiveGoals();
    
    if (typeof showPerformanceChart === "function" && document.getElementById('chartModal').style.display === 'block') {
        showPerformanceChart();
    }
}
  
function updatePlanButtons() {
    const btnA = document.getElementById('btnPlanA');
    const btnB = document.getElementById('btnPlanB');
    
    let lastDay = 0;
    let lastEff = 0;
    let lastTarget = 0;

    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    for (let d = 1; d <= 30; d++) {
        const effVal = document.getElementById(`resEffPerc_${d}`).value;
        const targetVal = document.getElementById(`targetEff_${d}`).value;
        
        if (effVal !== "" && targetVal !== "") {
            lastDay = d;
            lastEff = parseFloat(effVal);
            lastTarget = parseFloat(targetVal);
        }
    }

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£ Disable
    // 1. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
    if (lastDay === 0 || lastAdjustedDay === lastDay) {
        btnA.disabled = true;
        btnB.disabled = true;
        btnA.style.opacity = "0.5";
        btnB.style.opacity = "0.5";
    } else {
        // 2. ‡πÅ‡∏ú‡∏ô A ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á < ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        btnA.disabled = !(lastEff < lastTarget);
        btnA.style.opacity = (lastEff < lastTarget) ? "1" : "0.5";

        // 3. ‡πÅ‡∏ú‡∏ô B ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á > ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        btnB.disabled = !(lastEff > lastTarget);
        btnB.style.opacity = (lastEff > lastTarget) ? "1" : "0.5";
    }
}
  
// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Event Listener ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function checkButtonStatus(day, eff, target) {
    const btnA = document.getElementById('btnPlanA');
    const btnB = document.getElementById('btnPlanB');
    
    if (eff !== "" && target !== "") {
        const valEff = parseFloat(eff);
        const valTarget = parseFloat(target);
        
        btnA.disabled = !(valEff < valTarget);
        btnB.disabled = !(valEff > valTarget);
    }
}
  
  
  
  
  
  
  // ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô
let myChart = null;

function showPerformanceChart() {
    // 1. ‡πÄ‡∏õ‡∏¥‡∏î Modal
    document.getElementById('chartModal').style.display = 'block';

    // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const labels = []; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-30
    const targetData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    const actualData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á

    for (let d = 1; d <= 30; d++) {
        labels.push("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + d);
        
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡∏±‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ % ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const tVal = document.getElementById(`targetEff_${d}`).value;
        targetData.push(tVal ? parseFloat(tVal) : null);

        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á
        const aVal = document.getElementById(`resEffPerc_${d}`).value;
        actualData.push(aVal ? parseFloat(aVal) : null);
    }

    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
    if (myChart) { myChart.destroy(); }

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (%)',
                    data: targetData,
                    borderColor: '#007bff',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    tension: 0.1, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô
                    spanGaps: true // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                },
                {
                    label: '‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (%)',
                    data: actualData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.1,
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100, // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà 100%
                    title: { display: true, text: 'Percentage (%)' }
                }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
}
  
  

function exportToExcel() {
    const wb = XLSX.utils.book_new();
    
    // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Header ‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C)
    const headerData = [
        ["CSA OPERATION SIGN-OFF REPORT"],
        [""],
        [`‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å: ${document.getElementById('header_process')?.value || "-"}`],
        [`‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${document.getElementById('header_employee')?.value || "-"}`],
        [`‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å: ${document.getElementById('header_trainer')?.value || "-"}`], 
        [`‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô: ${document.getElementById('workLevel')?.value || "-"}`],
        [`SAM (‡∏ô‡∏≤‡∏ó‡∏µ): ${document.getElementById('globalSam')?.value || "0"}`], 
        [`‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Eff (%): ${document.getElementById('globalEffTarget')?.value || "0"}`], 
        [`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ù‡∏∂‡∏Å: ${document.getElementById('trainingDays')?.value || "0"}`],
        [`‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤: ${document.getElementById('fabricType')?.value || "-"}`], 
        [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å: ${document.getElementById('header_startDate')?.value || "-"}`], 
        [`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢: ${document.getElementById('header_transferDate')?.value || "-"}`],
        [""] 
    ];

    const ws = XLSX.utils.aoa_to_sheet(headerData);

    // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    const tableHeader1 = ["‡∏ß‡∏±‡∏ô", "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û", "", "", "", "", "", "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û", "", "", "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å", "", "", "", "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô"];
    const tableHeader2 = ["", "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (%)", "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏ä‡∏¥‡πâ‡∏ô)", "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)", "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (%)", "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)", "‡∏ú‡πà‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô", "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô %", "‡∏Ñ‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£", "‡∏ß‡∏±‡∏™‡∏î‡∏∏", "", ""];

    XLSX.utils.sheet_add_aoa(ws, [tableHeader1], { origin: "A13" });
    XLSX.utils.sheet_add_aoa(ws, [tableHeader2], { origin: "A14" });

    // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tbody 30 ‡πÅ‡∏ñ‡∏ß
    const rows = [];
    for (let d = 1; d <= 30; d++) {
        const rowData = [];
        rowData.push(d); 
        const inputs = [`targetEff_${d}`, `targetQty_${d}`, `resAvgSec_${d}`, `resAvgMin_${d}`, `resEffPerc_${d}`, `resEffPcs_${d}`, `qPass_${d}`, `qFail_${d}`, `resQRates_${d}`];
        inputs.forEach(id => rowData.push(document.getElementById(id)?.value || ""));
        const rowElem = document.querySelector(`#tableBody tr:nth-child(${d})`);
        rowElem.querySelectorAll('input[type="checkbox"]').forEach(cb => rowData.push(cb.checked ? "/" : ""));
        rowData.push(rowElem.querySelector('input[style*="text-align:left"]')?.value || "");
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢ logic ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
        const signImg = document.getElementById(`signImg_${d}`);
        const isSigned = signImg && window.getComputedStyle(signImg).display !== 'none' && signImg.src.startsWith('data:image');
        rowData.push(isSigned ? "SIGNED" : "-");

        rows.push(rowData);
    }
    XLSX.utils.sheet_add_aoa(ws, rows, { origin: "A15" });

    // 4. ‡πÉ‡∏™‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Borders) ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
    const range = XLSX.utils.decode_range("A13:P44"); // ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 30
    const borderStyle = {
        top: { style: "thin" },
        bottom: { style: "thin" },
        left: { style: "thin" },
        right: { style: "thin" }
    };

    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cell_address]) ws[cell_address] = { v: "" };
            ws[cell_address].s = { 
                border: borderStyle,
                alignment: { horizontal: "center", vertical: "center" }
            };
        }
    }

    // 5. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Merges ‡πÅ‡∏•‡∏∞ Columns (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    ws['!merges'] = [
        { s: { r: 12, c: 0 }, e: { r: 13, c: 0 } },
        { s: { r: 12, c: 1 }, e: { r: 12, c: 6 } },
        { s: { r: 12, c: 7 }, e: { r: 12, c: 9 } },
        { s: { r: 12, c: 10 }, e: { r: 12, c: 13 } },
        { s: { r: 12, c: 14 }, e: { r: 13, c: 14 } },
        { s: { r: 12, c: 15 }, e: { r: 13, c: 15 } }
    ];
    ws['!cols'] = [{ wch: 8 }, { wch: 22 }, { wch: 22 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 8 }, { wch: 8 }, { wch: 12 }, { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 35 }, { wch: 15 }];

    XLSX.utils.book_append_sheet(wb, ws, "Operation Report");
    const empName = document.getElementById('header_employee')?.value || "Employee";
    XLSX.writeFile(wb, `CSA_Report_${empName}_${new Date().toLocaleDateString()}.xlsx`);
}

function clearAllData() {
    if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ")) {
        // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Form Header
        const headerInputs = document.querySelectorAll('.form-header input, .form-header select');
        headerInputs.forEach(input => {
            if (input.type === 'date' || input.type === 'number' || input.type === 'text') {
                input.value = "";
            } else if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            }
        });

        // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á 30 ‡πÅ‡∏ñ‡∏ß
        for (let d = 1; d <= 30; d++) {
    const rowInputs = document.querySelectorAll(`#tableBody tr:nth-child(${d}) input`);
    rowInputs.forEach(input => {
        if (input.type === 'checkbox') {
            input.checked = false;
        } else {
            input.value = "";
        }

        if (input.id === `resAvgSec_${d}`) {
            input.className = "clickable-input";
        } else {
            input.className = "";
        }
    });

            // ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
            const signImg = document.getElementById(`signImg_${d}`);
            const signText = document.getElementById(`signText_${d}`);
            if (signImg) {
                signImg.src = "";
                signImg.style.display = 'none';
            }
            if (signText) {
                signText.style.display = 'block';
            }
        }

        // 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        resetTimer();
        document.getElementById('targetDay').value = 1;
        
        // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Goal ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        calculateAdaptiveGoals();
        
        alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      lastAdjustedDay = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô
        updatePlanButtons(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
    }
} 
  
  
  
let startTime, timerInterval, elapsedTime = 0, isRunning = false;
let currentActiveDay = null;

const tbody = document.getElementById("tableBody");
for(let d=1; d<=30; d++) {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td class="day-cell">${d}</td>
        <td><input type="text" id="targetEff_${d}" readonly></td>
        <td><input type="text" id="targetQty_${d}" readonly></td>
        <td><input type="text" id="resAvgSec_${d}" readonly class="clickable-input" onclick="openManualModal(${d})" placeholder=""></td>
        <td><input type="text" id="resAvgMin_${d}" readonly></td>
        <td><input type="text" id="resEffPerc_${d}" readonly style="background:#fff3cd;"></td>
        <td><input type="text" id="resEffPcs_${d}" readonly></td>
        <td><input type="number" id="qPass_${d}" inputmode="numeric" oninput="manualCalculate(${d})"></td>
        <td><input type="number" id="qFail_${d}" inputmode="numeric" oninput="manualCalculate(${d})"></td>
        <td><input type="text" id="resQRates_${d}" readonly></td>
        <td><input type="checkbox"></td><td><input type="checkbox"></td>
        <td><input type="checkbox"></td><td><input type="checkbox"></td>
        <td><input type="text" style="text-align:left;"></td>
        <td class="sign-cell" onclick="openSignPad(${d})">
            <span class="placeholder-text" id="signText_${d}">‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠</span>
            <img id="signImg_${d}" src="">
        </td>
    `;
    tbody.appendChild(row);
}

function updateAutoTargetDay() {
    let lastDayWithData = 0;
    for (let d = 1; d <= 30; d++) {
        if (document.getElementById(`resEffPerc_${d}`).value !== "") {
            lastDayWithData = d;
        }
    }
    let nextDay = lastDayWithData + 1;
    if (nextDay > 30) nextDay = 30;
    document.getElementById('targetDay').value = nextDay;
}

function openManualModal(day) {
    currentActiveDay = day;
    document.getElementById('modalDayLabel').innerText = day;
    const currentVal = document.getElementById(`resAvgSec_${day}`).value;
    document.getElementById('manualSecondsInput').value = currentVal || "";
    document.getElementById('manualInputModal').style.display = 'block';
    setTimeout(() => document.getElementById('manualSecondsInput').focus(), 100);
}

function closeManualModal() {
    document.getElementById('manualInputModal').style.display = 'none';
}

function saveManualSeconds() {
    const sec = parseFloat(document.getElementById('manualSecondsInput').value);
    if (!isNaN(sec) && sec >= 0) {
        document.getElementById(`resAvgSec_${currentActiveDay}`).value = sec.toFixed(2);
        manualCalculate(currentActiveDay);
        updateAutoTargetDay();
        closeManualModal();
    } else {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}

function handleAvgSecChange(d) {
    const avgSecInput = document.getElementById(`resAvgSec_${d}`);
    const qFailInput = document.getElementById(`qFail_${d}`);

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
    if (avgSecInput.value !== "" && qFailInput.value === "") {
        qFailInput.value = 0;
        
        // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á "‡∏ú‡πà‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô %" ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°
        if (typeof calculateQuality === "function") {
            calculateQuality(d);
        }
    }
}
  
  
// --- Adaptive Logic (v1.9.0: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏° "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å") ---
function calculateAdaptiveGoals() {
    const globalEff = parseFloat(document.getElementById('globalEffTarget').value) || 0;
    const trainDays = parseInt(document.getElementById('trainingDays').value) || 0;
    const sam = parseFloat(document.getElementById('globalSam').value) || 0;

    const qtyT = (sam > 0) ? Math.ceil((60 / sam) * (globalEff / 100)) : 0;
    document.getElementById('globalQtyTarget').value = qtyT;

    let firstDayQ100 = 0;
    for (let d = 1; d <= 30; d++) {
        if (document.getElementById(`resQRates_${d}`).value === "100%") {
            firstDayQ100 = d;
            break; 
        }
    }

    let lastActualEff = 0, lastActualDay = 0;
    for (let d = 1; d <= 30; d++) {
        let effStr = document.getElementById(`resEffPerc_${d}`).value;
        if (effStr && effStr !== "") { 
            lastActualEff = parseFloat(effStr); 
            lastActualDay = d; 
        }
    }

    for (let d = 1; d <= 30; d++) {
        const targetInput = document.getElementById(`targetEff_${d}`);
        const targetQtyInput = document.getElementById(`targetQty_${d}`);
        const effInput = document.getElementById(`resEffPerc_${d}`);
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà ---
        // 1. ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô "‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß" (d <= lastActualDay) 
        //    ‡πÅ‡∏•‡∏∞ "‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß" ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
        if (d <= lastActualDay && targetInput.value !== "") {
            // ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
        } 
        else {
            let targetValue = 0;
            let showTarget = false;

            if (firstDayQ100 > 0 && d > firstDayQ100 && d <= trainDays) {
                showTarget = true;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Future Days)
                const remainingDays = trainDays - lastActualDay;
                if (remainingDays > 0) {
                    const increment = (globalEff - lastActualEff) / remainingDays;
                    targetValue = lastActualEff + (increment * (d - lastActualDay));
                } else { 
                    targetValue = globalEff; 
                }
            }

            if (showTarget) {
                const finalT = Math.ceil(Math.min(targetValue, globalEff));
                targetInput.value = finalT + "%";
                if (sam > 0) targetQtyInput.value = Math.ceil((60 / sam) * (finalT / 100));
            } else {
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ù‡∏∂‡∏Å
                targetInput.value = ""; 
                targetQtyInput.value = "";
            }
        }
        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

        // ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏µ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        const currentEff = parseFloat(effInput.value) || 0;
        const currentTarget = parseFloat(targetInput.value) || 0;
        
        if (effInput.value !== "" && targetInput.value !== "") {
            if (currentEff >= currentTarget) {
                effInput.className = "text-success";
            } else {
                effInput.className = "text-danger";
            }
        } else {
            effInput.className = ""; 
          updatePlanButtons(); 
        }
    }
}

function manualCalculate(d) {
    const sam = parseFloat(document.getElementById('globalSam').value) || 0;
    const avgSec = parseFloat(document.getElementById(`resAvgSec_${d}`).value) || 0;
    const pass = parseFloat(document.getElementById(`qPass_${d}`).value) || 0;
    const fail = parseFloat(document.getElementById(`qFail_${d}`).value) || 0;

    if (avgSec > 0) {
        const avgMin = avgSec / 60;
        document.getElementById(`resAvgMin_${d}`).value = avgMin.toFixed(2);
        if (sam > 0) {
            document.getElementById(`resEffPerc_${d}`).value = Math.ceil((sam / avgMin) * 100) + "%";
            document.getElementById(`resEffPcs_${d}`).value = Math.ceil(60 / avgMin);
        }
    }

    const totalQ = pass + fail;
    document.getElementById(`resQRates_${d}`).value = (totalQ > 0) ? Math.ceil((pass / totalQ) * 100) + "%" : "";
    
    calculateAdaptiveGoals();
}

function toggleTimer() {
    const btn = document.getElementById('startStopBtn');
    if (!isRunning) {
        isRunning = true; btn.innerText = "Stop"; btn.className = "btn btn-stop";
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(() => {
            elapsedTime = Date.now() - startTime;
            updateTimerDisplay();
        }, 10);
    } else {
        isRunning = false; btn.innerText = "Continue"; btn.className = "btn btn-start";
        clearInterval(timerInterval);
    }
}

function updateTimerDisplay() {
    const totalSec = Math.floor(elapsedTime / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
    const s = (totalSec % 60).toString().padStart(2, '0');
    const ms = Math.floor((elapsedTime % 1000) / 10).toString().padStart(2, '0');
    document.getElementById('timerDisplay').innerText = `${m}:${s}:${ms}`;
}

function resetTimer() {
    clearInterval(timerInterval);
    elapsedTime = 0; isRunning = false;
    document.getElementById('timerDisplay').innerText = "00:00:00";
    document.getElementById('startStopBtn').innerText = "Start"
}

function recordAndCalculate() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å input
    const day = document.getElementById('targetDay').value;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (elapsedTime === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    const cyclesElem = document.getElementById('cyclesDone');
    const cycles = cyclesElem ? (parseFloat(cyclesElem.value) || 1) : 1;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const avgSec = (elapsedTime / 1000) / cycles;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)"
    const targetInput = document.getElementById(`resAvgSec_${day}`);
    if (targetInput) {
        targetInput.value = avgSec.toFixed(2);
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
        manualCalculate(day);
        
        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        updateAutoTargetDay();
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
        resetTimer(); 
    } else {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á");
    }
}

// ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let writing = false;
function openSignPad(day) { currentActiveDay = day; document.getElementById('signModal').style.display = 'block'; clearPad(); }
function closeSignPad() { document.getElementById('signModal').style.display = 'none'; }
function clearPad() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.lineWidth = 2; ctx.strokeStyle = '#1a3c6d'; }
function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
}
canvas.addEventListener('mousedown', (e) => { writing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); });
canvas.addEventListener('mousemove', (e) => { if(!writing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); });
window.addEventListener('mouseup', () => writing = false);
canvas.addEventListener('touchstart', (e) => { writing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); e.preventDefault(); }, {passive: false});
canvas.addEventListener('touchmove', (e) => { if(!writing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); }, {passive: false});
function saveSignature() {
    const dataURL = canvas.toDataURL();
    document.getElementById(`signImg_${currentActiveDay}`).src = dataURL;
    document.getElementById(`signImg_${currentActiveDay}`).style.display = 'block';
    document.getElementById(`signText_${currentActiveDay}`).style.display = 'none';
    closeSignPad();
}

calculateAdaptiveGoals();
updateAutoTargetDay();

</script>

</body>
  <footer style="text-align: center; padding: 20px; color: #888; font-size: 12px; font-family: sans-serif;">
    <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 10px;">
    <p>¬© CSA OPERATION SIGN-OFF REPORT  | v1.0.10</p>
</footer>
</html>
