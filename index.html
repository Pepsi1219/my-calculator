<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSA Operation Sign-Off Report (v1.9.0)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; }
        body { background: #f8f9fa; padding: 15px; }
        .report-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.1); max-width: 1550px; margin: auto; }
        .report-title { text-align: center; margin-bottom: 20px; color: #1a3c6d; border-bottom: 2px solid #1a3c6d; padding-bottom: 10px; }
        .form-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px 16px; margin-bottom: 20px; background: #f0f4ff; padding: 15px; border-radius: 8px; }
        .field { display: flex; flex-direction: column; }
        .field label { font-size: .85rem; margin-bottom: 4px; font-weight: 600; color: #444; }
        .field input, .field select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; background: white; }
        .field input[readonly] { background: #e9ecef; }
        
        .stopwatch-bar { background: #fff; border: 0px solid #1a3c6d; padding: 12px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .timer-display { font-size: 1.8rem; font-weight: bold; font-family: monospace; background: #222; color: #00ff00; padding: 5px 15px; border-radius: 8px; min-width: 140px; text-align: center; }
        
        .table-wrapper { overflow-x: auto; }
        .report-table {
          width: 100%;
          border-collapse: collapse;
          min-width: 1400px;
          font-size: .75rem;
          table-layout: fixed;
      }
        .cause-col {
          width: 40px;
      }
        th, td { border: .5px solid #ccc; padding: 6px; text-align: center; vertical-align: middle; }
        th { background: #e9ecef; }
        .day-cell { background: #f0f4ff; font-weight: bold; }
        .clickable-input { cursor: pointer; background: #fffde7 !important; font-weight: bold; color: #1a3c6d; border: 1px solid #ffe082 !important; border-radius: 4px; }
        .report-table input { width: 100%; border: none; padding: 4px; text-align: center; background: transparent; }
        
        .text-success { color: #28a745 !important; font-weight: bold; }
        .text-danger { color: #dc3545 !important; font-weight: bold; }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; margin: 15% auto; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal-content input { width: 100%; padding: 12px; font-size: 1.5rem; text-align: center; border: 2px solid #007bff; border-radius: 8px; margin-bottom: 20px; }
        
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-start { background: #28a745; } .btn-stop { background: #dc3545; } .btn-save { background: #007bff; } .btn-reset { background: #6c757d; }
        .sign-btn-group { display: flex; gap: 10px; justify-content: center; }
        
        .sign-cell { cursor: pointer; min-width: 120px; height: 50px; background: #fff; display: flex; align-items: center; justify-content: center; }
        .sign-cell img { max-height: 45px; display: none; }
        #signature-pad { border: 2px dashed #ccc; background: #fff; margin-bottom: 15px; touch-action: none; }
    </style>
</head>
<body>

<div class="report-container">
    <h1 class="report-title">CSA OPERATION SIGN-OFF REPORT</h1>

    <div class="form-header">
        <div class="field"><label>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å</label><input type="text"></div>
        <div class="field"><label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text"></div>
        <div class="field"><label>‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å</label><input type="text"></div>
        <div class="field"><label>SAM (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input type="number" id="globalSam" step="0.001" inputmode="decimal" oninput="calculateAdaptiveGoals()"></div>
        <div class="field"><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Eff (%)</label><input type="number" id="globalEffTarget" inputmode="numeric" oninput="calculateAdaptiveGoals()"></div>
        <div class="field"><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Q'ty (‡∏ä‡∏¥‡πâ‡∏ô/‡∏ä‡∏°.)</label><input type="number" id="globalQtyTarget" readonly></div>
        <div class="field">
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label>
            <select id="workLevel">
                <option value="" disabled selected></option>
                <option value="A">A</option><option value="B">B</option>
                <option value="C">C</option><option value="D">D</option>
            </select>
        </div>
        <div class="field"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å</label><input type="number" id="trainingDays" inputmode="numeric" oninput="calculateAdaptiveGoals()"></div>
        <div class="field">
            <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤</label>
            <select id="fabricType">
                <option value="" disabled selected></option>
                <option value="Knitted">‡∏ú‡πâ‡∏≤‡∏ñ‡∏±‡∏Å (Knitted Fabric)</option>
                <option value="Woven">‡∏ú‡πâ‡∏≤‡∏ó‡∏≠ (Woven Fabric)</option>
            </select>
        </div>
        <div class="field"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å</label><input type="date"></div>
        <div class="field"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</label><input type="date"></div>
    </div>

    <div class="stopwatch-bar">
        
        <div id="timerDisplay" class="timer-display">00:00:00</div>
        <button class="btn btn-start" id="startStopBtn" onclick="toggleTimer()">Start</button>
        <button class="btn btn-reset" onclick="resetTimer()">Reset</button>
        <div class="control-group" style="padding-left:15px; border-left:3px solid #007bff;">
        </div>
        <button class="btn btn-save" onclick="recordAndCalculate()">üíæ Save</button>
    </div>
  
  
     <div class="control-group">
         <label>‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà:</label>
         <input type="number"
                id="targetDay"
                value="1"
                min="1"
                max="30"
                inputmode="numeric"
                style="width: 60px; text-align: center;
                       border: 0px solid #007bff; font-weight: bold;">
        </div>

    <div class="table-wrapper">
        <table class="report-table">
            <table class="report-table">
              <colgroup>
                <col style="width:60px">
                <col span="6">
                <col span="3">
                <col class="cause-col">
                <col class="cause-col">
                <col class="cause-col">
                <col class="cause-col">
                <col style="width:180px">
                <col style="width:140px">
         </colgroup>
              
            <thead>
                <tr>
                    <th rowspan="2">‡∏ß‡∏±‡∏ô</th>
                    <th colspan="6">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</th>
                    <th colspan="3">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</th>
                    <th colspan="4">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å</th>
                    <th rowspan="2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                    <th rowspan="2">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</th>
                </tr>
                <tr>
                    <th>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (%)</th>
                    <th> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                    <th> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                    <th>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (%)</th>
                    <th>‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á (‡∏ä‡∏¥‡πâ‡∏ô)</th>
                    <th>‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</th>
                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô %</th>
                    <th>‡∏Ñ‡∏ô</th>
                    <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                    <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="manualInputModal" class="modal">
    <div class="modal-content">
        <h3>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="modalDayLabel"></span></p>
        <input type="number" id="manualSecondsInput" step="0.01" inputmode="decimal" placeholder="00">
        <div class="sign-btn-group">
            <button class="btn btn-save" 
             onclick="saveManualSeconds()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-stop" 
             onclick="closeManualModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<div id="signModal" class="modal">
    <div class="modal-content">
        <h3>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</h3>
        <canvas id="signature-pad" width="450" height="200"></canvas>
        <div class="sign-btn-group">
            <button class="btn btn-reset" 
                    onclick="clearPad()">‡∏•‡πâ‡∏≤‡∏á</button>
            <button class="btn btn-save" 
                    onclick="saveSignature()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-stop" 
                    onclick="closeSignPad()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<script>
let startTime, timerInterval, elapsedTime = 0, isRunning = false;
let currentActiveDay = null;

const tbody = document.getElementById("tableBody");
for(let d=1; d<=30; d++) {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td class="day-cell">${d}</td>
        <td><input type="text" id="targetEff_${d}" readonly></td>
        <td><input type="text" id="targetQty_${d}" readonly></td>
        <td><input type="text" id="resAvgSec_${d}" readonly class="clickable-input" onclick="openManualModal(${d})" placeholder="‡πÅ‡∏ï‡∏∞"></td>
        <td><input type="text" id="resAvgMin_${d}" readonly></td>
        <td><input type="text" id="resEffPerc_${d}" readonly style="background:#fff3cd;"></td>
        <td><input type="text" id="resEffPcs_${d}" readonly></td>
        <td><input type="number" id="qPass_${d}" inputmode="numeric" oninput="manualCalculate(${d})"></td>
        <td><input type="number" id="qFail_${d}" inputmode="numeric" oninput="manualCalculate(${d})"></td>
        <td><input type="text" id="resQRates_${d}" readonly></td>
        <td><input type="checkbox"></td><td><input type="checkbox"></td>
        <td><input type="checkbox"></td><td><input type="checkbox"></td>
        <td><input type="text" style="text-align:left;"></td>
        <td class="sign-cell" onclick="openSignPad(${d})">
            <span class="placeholder-text" id="signText_${d}">‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠</span>
            <img id="signImg_${d}" src="">
        </td>
    `;
    tbody.appendChild(row);
}

 
  
function updateAutoTargetDay() {
    let lastDayWithData = 0;
    for (let d = 1; d <= 30; d++) {
        if (document.getElementById(`resEffPerc_${d}`).value !== "") {
            lastDayWithData = d;
        }
    }
    let nextDay = lastDayWithData + 1;
    if (nextDay > 30) nextDay = 30;
    document.getElementById('targetDay').value = nextDay;
}

function openManualModal(day) {
    currentActiveDay = day;
    document.getElementById('modalDayLabel').innerText = day;
    const currentVal = document.getElementById(`resAvgSec_${day}`).value;
    document.getElementById('manualSecondsInput').value = currentVal || "";
    document.getElementById('manualInputModal').style.display = 'block';
    setTimeout(() => document.getElementById('manualSecondsInput').focus(), 100);
}

function closeManualModal() {
    document.getElementById('manualInputModal').style.display = 'none';
}

function saveManualSeconds() {
    const sec = parseFloat(document.getElementById('manualSecondsInput').value);
    if (!isNaN(sec) && sec >= 0) {
        document.getElementById(`resAvgSec_${currentActiveDay}`).value = sec.toFixed(2);
        manualCalculate(currentActiveDay);
        updateAutoTargetDay();
        closeManualModal();
    } else {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
}

// --- Adaptive Logic (v1.9.0: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏° "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å") ---
function calculateAdaptiveGoals() {
    const globalEff = parseFloat(document.getElementById('globalEffTarget').value) || 0;
    const trainDays = parseInt(document.getElementById('trainingDays').value) || 0; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô
    const sam = parseFloat(document.getElementById('globalSam').value) || 0;

    const qtyT = (sam > 0) ? Math.ceil((60 / sam) * (globalEff / 100)) : 0;
    document.getElementById('globalQtyTarget').value = qtyT;

    let firstDayQ100 = 0;
    for (let d = 1; d <= 30; d++) {
        if (document.getElementById(`resQRates_${d}`).value === "100%") {
            firstDayQ100 = d;
            break; 
        }
    }

    let lastActualEff = 0, lastActualDay = 0;
    for (let d = 1; d <= 30; d++) {
        let effStr = document.getElementById(`resEffPerc_${d}`).value;
        if (effStr) { 
            lastActualEff = parseFloat(effStr); 
            lastActualDay = d; 
        }
    }

    for (let d = 1; d <= 30; d++) {
        const targetInput = document.getElementById(`targetEff_${d}`);
        const targetQtyInput = document.getElementById(`targetQty_${d}`);
        const effInput = document.getElementById(`resEffPerc_${d}`);
        
        let targetValue = 0;
        let showTarget = false;

        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç v1.9.0: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Q100) AND (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
        if (firstDayQ100 > 0 && d > firstDayQ100 && d <= trainDays) {
            showTarget = true;
            if (d <= lastActualDay) {
                targetValue = (globalEff / trainDays) * d; 
            } else {
                const remainingDays = trainDays - lastActualDay;
                if (remainingDays > 0) {
                    const increment = (globalEff - lastActualEff) / remainingDays;
                    targetValue = lastActualEff + (increment * (d - lastActualDay));
                } else { targetValue = globalEff; }
            }
        }

        if (showTarget) {
            const finalT = Math.ceil(Math.min(targetValue, globalEff));
            targetInput.value = finalT + "%";
            if (sam > 0) targetQtyInput.value = Math.ceil((60 / sam) * (finalT / 100));
        } else {
            targetInput.value = ""; targetQtyInput.value = "";
        }

        const currentEff = parseFloat(effInput.value) || 0;
        const currentTarget = parseFloat(targetInput.value) || 0;
        
        if (effInput.value !== "" && targetInput.value !== "") {
            if (currentEff >= currentTarget) {
                effInput.className = "text-success";
            } else {
                effInput.className = "text-danger";
            }
        } else {
            effInput.className = ""; 
        }
    }
}

function manualCalculate(d) {
    const sam = parseFloat(document.getElementById('globalSam').value) || 0;
    const avgSec = parseFloat(document.getElementById(`resAvgSec_${d}`).value) || 0;
    const pass = parseFloat(document.getElementById(`qPass_${d}`).value) || 0;
    const fail = parseFloat(document.getElementById(`qFail_${d}`).value) || 0;

    if (avgSec > 0) {
        const avgMin = avgSec / 60;
        document.getElementById(`resAvgMin_${d}`).value = avgMin.toFixed(2);
        if (sam > 0) {
            document.getElementById(`resEffPerc_${d}`).value = Math.ceil((sam / avgMin) * 100) + "%";
            document.getElementById(`resEffPcs_${d}`).value = Math.ceil(60 / avgMin);
        }
    }

    const totalQ = pass + fail;
    document.getElementById(`resQRates_${d}`).value = (totalQ > 0) ? Math.ceil((pass / totalQ) * 100) + "%" : "";
    
    calculateAdaptiveGoals();
}

function toggleTimer() {
    const btn = document.getElementById('startStopBtn');
    if (!isRunning) {
        isRunning = true; btn.innerText = "Stop"; btn.className = "btn btn-stop";
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(() => {
            elapsedTime = Date.now() - startTime;
            updateTimerDisplay();
        }, 10);
    } else {
        isRunning = false; btn.innerText = "Continue"; btn.className = "btn btn-start";
        clearInterval(timerInterval);
    }
}

function updateTimerDisplay() {
    const totalSec = Math.floor(elapsedTime / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
    const s = (totalSec % 60).toString().padStart(2, '0');
    const ms = Math.floor((elapsedTime % 1000) / 10).toString().padStart(2, '0');
    document.getElementById('timerDisplay').innerText = `${m}:${s}:${ms}`;
}

function resetTimer() {
    clearInterval(timerInterval);
    elapsedTime = 0; isRunning = false;
    document.getElementById('timerDisplay').innerText = "00:00:00";
    document.getElementById('startStopBtn').innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
}

function recordAndCalculate() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å input
    const day = document.getElementById('targetDay').value;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (elapsedTime === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô");

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á cyclesDone (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ default ‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î Error)
    const cyclesElem = document.getElementById('cyclesDone');
    const cycles = cyclesElem ? (parseFloat(cyclesElem.value) || 1) : 1;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const avgSec = (elapsedTime / 1000) / cycles;
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)" ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÜ
    const targetInput = document.getElementById(`resAvgSec_${day}`);
    if (targetInput) {
        targetInput.value = avgSec.toFixed(2);
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
        manualCalculate(day);
        
        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ß‡∏±‡∏ô/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        updateAutoTargetDay();
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
        resetTimer(); 
    } else {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á");
    }
}

// ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let writing = false;
function openSignPad(day) { currentActiveDay = day; document.getElementById('signModal').style.display = 'block'; clearPad(); }
function closeSignPad() { document.getElementById('signModal').style.display = 'none'; }
function clearPad() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.lineWidth = 2; ctx.strokeStyle = '#1a3c6d'; }
function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
}
canvas.addEventListener('mousedown', (e) => { writing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); });
canvas.addEventListener('mousemove', (e) => { if(!writing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); });
window.addEventListener('mouseup', () => writing = false);
canvas.addEventListener('touchstart', (e) => { writing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); e.preventDefault(); }, {passive: false});
canvas.addEventListener('touchmove', (e) => { if(!writing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); }, {passive: false});
function saveSignature() {
    const dataURL = canvas.toDataURL();
    document.getElementById(`signImg_${currentActiveDay}`).src = dataURL;
    document.getElementById(`signImg_${currentActiveDay}`).style.display = 'block';
    document.getElementById(`signText_${currentActiveDay}`).style.display = 'none';
    closeSignPad();
}

calculateAdaptiveGoals();
updateAutoTargetDay();
</script>

</body>
  <footer style="text-align: center; padding: 20px; color: #888; font-size: 12px; font-family: sans-serif;">
    <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 10px;">
    <p>¬© CSA OPERATION SIGN-OFF REPORT  | v1.0.10</p>
</footer>
</html>
